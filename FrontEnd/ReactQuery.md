## React Query ë€?

Reactì—ì„œ `ë°ì´í„° fetching`ê³¼ `ìºì‹± í”„ë¡œì„¸ìŠ¤`ë¥¼ ê°„ì†Œí™”í•´ì£¼ëŠ” **ë¼ì´ë¸ŒëŸ¬ë¦¬**

- ì™¸ë¶€(API ë“±)ë¡œë¶€í„° ë°ì´í„°ë¥¼ fetching ë° ì—…ë°ì´íŠ¸ ê³¼ì • ê°„ì†Œí™”
- API ìš”ì²­ì˜ ë¡œë”© ë° ì˜¤ë¥˜ ìƒíƒœ ê´€ë¦¬
- ìºì‹± ìë™ ê´€ë¦¬

Redux, Recoil ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ëŠ” ë‹¤ë¥¸ ê²°ì´ë‹¤. ê·¸ë“¤ì€ **í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬**!

## Client State vs Server State

|                                             | Client State                                                      | Server State                                                               |
| ------------------------------------------- | ----------------------------------------------------------------- | -------------------------------------------------------------------------- |
| ìœ„ì¹˜                                        | í´ë¼ì´ì–¸íŠ¸ì— ì €ì¥ëœ ë°ì´í„°                                        | ì„œë²„ë‚˜ ì™¸ë¶€ ë°ì´í„° ì†ŒìŠ¤ì— ì €ì¥ëœ ë°ì´í„°                                    |
| ì ‘ê·¼ì„±                                      | í´ë¼ì´ì–¸íŠ¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥                                            | ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ì ‘ê·¼ ê°€ëŠ¥                                 |
| ë°ì´í„° ê´€ë¦¬                                 | í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê´€ë¦¬                                               |
| (Redux, Recoil ë“± ìƒíƒœê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©) | ì„œë²„ì—ì„œ ê´€ë¦¬                                                     |
| (ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©)                         |
| ì§€ì†ì„±                                      | ì„¸ì…˜ ê°„ì— í•„ì—°ì ìœ¼ë¡œ ì§€ì†ë˜ì§„ ì•ŠìŒ                                | ì¼ë°˜ì ìœ¼ë¡œ ì„¸ì…˜ ê°„ì— ì§€ì†ì„± ìœ ì§€                                           |
| ë„¤íŠ¸ì›Œí¬ ìš”ì²­                               | ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ì—…ë°ì´íŠ¸í•˜ë ¤ë©´ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ | ë°ì´í„° ì ‘ê·¼ ë˜ëŠ” ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ            |
| ë³´ì•ˆ                                        | í´ë¼ì´ì–¸íŠ¸ê°€ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆê³  ë³´ì•ˆ ìˆ˜ì¤€ì´ ë‚®ìŒ                    | ì¸ì¦ ë° ì•”í˜¸í™”ë¡œ ë³´í˜¸í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë” ì•ˆì „                                |
| ì„±ëŠ¥                                        | server stateì— ë¹„í•´ ì†ë„ ë¹ ë¦„                                     | client stateì— ë¹„í•´ ì†ë„ ëŠë¦¼                                              |
| í™•ì¥ì„±                                      | í´ë¼ì´ì–¸íŠ¸ ê¸°ê¸° ìš©ëŸ‰ì´ ì œí•œì ì´ì–´ì„œ í™•ì¥ì„±ì´ ë‹¤ì†Œ ë–¨ì–´ì§          | ì „ìš© ì„œë²„ë‚˜ ë°ì´í„° ì†ŒìŠ¤ë¡œ ê´€ë¦¬ë˜ê¸° ë•Œë¬¸ì— ìš©ëŸ‰ì´ ì»¤ì„œ í™•ì¥ì„±ì´ ë¹„êµì  ë†’ìŒ |
| ì˜ˆì‹œ                                        | ì»´í¬ë„ŒíŠ¸ state, Redux state, ë¸Œë¼ìš°ì € ì¿ í‚¤                        | DB ë ˆì½”ë“œ, API ì‘ë‹µ, ì„œë²„ ì„¸ì…˜ ë°ì´í„°                                      |

ê¸°ì¡´ì˜ Client State ê´€ë¦¬ëŠ”

- Redux
- React Context API
- Recoil

ë“±ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í†µí•´ ê´€ë¦¬í•œë‹¤.

Clientì—ì„œ APIì™€ í†µì‹ ì„ í•˜ê¸° ìœ„í•´ì„œëŠ”

ì¶”ê°€ì ìœ¼ë¡œ useEffect, useStateë¥¼ í•¨ê»˜ ì“°ë©´ì„œ ë°ì´í„°ë¥¼ fetching í•´ì™”ë‹¤.

í•˜ì§€ë§Œ React Queryë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ¬í•œ í›…ë“¤ì˜ í•„ìš”ì„±ì´ ì‚¬ë¼ì§„ë‹¤.

## React Query ì£¼ìš” ê°œë…

`Query`

API ì—”ë“œí¬ì¸íŠ¸, DB ë“±ì˜ ì›ê²© ë°ì´í„° ì†ŒìŠ¤ë¡œë¶€í„° ë°ì´í„° ìš”ì²­

- **useQuery** í›… ì‚¬ìš©

`Mutation`

ì„œë²„ì— ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸

- **useMutation** í›… ì‚¬ìš©

`Query Caching`

Query ê²°ê³¼ë¥¼ ë©”ëª¨ë¦¬ì— ì €ì¥

`Query Invalidation`

ì¿¼ë¦¬ë¥¼ ì˜¤ë˜ëœ ìƒíƒœë¡œ ì—¬ê²¨ ë¬´íš¨í™”

## 1ï¸âƒ£ useQuery í›…

> **ë°ì´í„° Fetching ìš©**

API ì—”ë“œí¬ì¸íŠ¸ë‚˜ DBì—ì„œ ë°ì´í„°ë¥¼ **ë¹„ë™ê¸°ì **ìœ¼ë¡œ ê°€ì ¸ì˜¤ë„ë¡ ì„œë²„ì— ìš”ì²­í•˜ëŠ” ê²ƒ

### **ì‚¬ìš©ë²•**

```jsx
const query = useQuery( { queryKey: [ â€˜keyâ€™ ],   queryFn: callback })
```

`queryKey` ì¿¼ë¦¬ì˜ **ê³ ìœ  í‚¤**

- React Query ìµœì‹  ë²„ì „ë¶€í„°ëŠ” **ë°°ì—´ í‘œê¸°ë²•**ì„ ì‚¬ìš©í•´ì„œ í‚¤ ì§€ì •

`queryFn` í›… í˜¸ì¶œ ì‹œ ì‹¤í–‰ë˜ëŠ” **Promise ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜**

- í•´ë‹¹ callbackí•¨ìˆ˜ì—ì„œ ë°ì´í„° fetching

```jsx
// ì˜ˆì‹œ
const getProducts = () => fetch( 'https://jsonplaceholder.typicode.com/users')
                          .then( res  => res.json() )

const query = useQuery( { queryKey: [â€˜usersâ€™],   queryFn: getTodos })
```

`ë°˜í™˜ê°’` ì¿¼ë¦¬ì˜ ìƒíƒœ ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” **ê°ì²´**

```jsx

const { isLoading, isError, data, error, refetch, remove } = useQuery( { queryKey: [â€˜todosâ€™], queryFn: getTodos });
```

ëŒ€í‘œì ì¸ **í”„ë¡œí¼í‹°**

- `isLoading` ì¿¼ë¦¬ê°€ í˜„ì¬ ë¡œë”© ì¤‘ì¸ì§€ ì—¬ë¶€ (boolean)
- `isError` ì¿¼ë¦¬ ê²°ê³¼ê°€ ì˜¤ë¥˜ì¸ì§€ ì—¬ë¶€ (boolean)
- `data` ì¿¼ë¦¬ë¥¼ í†µí•´ ì„±ê³µì ìœ¼ë¡œ fetchingëœ ë°ì´í„°
- `error` ì¿¼ë¦¬ ì‹¤í–‰ ì¤‘ ë°œìƒí•œ ëª¨ë“  ì—ëŸ¬
- `refetch` ì¿¼ë¦¬ ë°ì´í„°ë¥¼ ìˆ˜ë™ìœ¼ë¡œ refetch í•˜ëŠ” íŠ¸ë¦¬ê±° **ë©”ì†Œë“œ**
- `remove` ìºì‹œì—ì„œ íŠ¹ì • ì¿¼ë¦¬ ì œê±°í•˜ëŠ” **ë©”ì†Œë“œ**

### ë°ì´í„° refetching

`useQuery`ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ

- **ì»´í¬ë„ŒíŠ¸ ìµœì´ˆ mount ì‹œ**ì— ë°ì´í„°ë¥¼ fetchingí•´ì˜¤ê³ ,
- ì´í›„ì˜ ë°ì´í„° ì—…ë°ì´íŠ¸ì— ëŒ€í•´ì„œëŠ” **ìë™ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤. (ë°ì´í„° refetching ì•ˆí•´ì¤Œ)**

**[ useQuery ì˜µì…˜ ]**

| ì˜µì…˜                 | ì—­í•                                                          | ê¸°ë³¸ê°’ |
| -------------------- | ------------------------------------------------------------ | ------ |
| refetchOnWindowFocus | ë°ì´í„°ê°€ ì˜¤ë˜ëœ(stale) ê²½ìš° ë¸Œë¼ìš°ì € ì°½ì´ í¬ì»¤ìŠ¤ ë˜ë©´ ë¦¬í˜ì¹˜ | true   |
| refetchOnMount       | ë°ì´í„°ê°€ ì˜¤ë˜ëœ ê²½ìš° ë§ˆìš´íŠ¸ ì‹œ ë¦¬í˜ì¹˜                        | true   |
| refetchOnReconnect   | ë°ì´í„°ê°€ ì˜¤ë˜ëœ ê²½ìš° ì¬ì—°ê²° ì‹œ ë¦¬í˜ì¹˜                        | true   |

í•˜ì§€ë§Œ ë¸Œë¼ìš°ì €ê°€ **idle** ìƒíƒœë¥¼ ìœ ì§€í•  ë•Œì—”, ë°ì´í„° ì—…ë°ì´íŠ¸ë¥¼ ê°ì§€í•˜ì—¬ ìë™ìœ¼ë¡œ ë¦¬í˜ì¹˜í•´ì£¼ì§€ ì•ŠëŠ”ë‹¤.

ì´ë¥¼ ë³´ì™„í•˜ê¸° ìœ„í•´ì„œ `refetchIntervel` ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

- ì„¤ì •í•œ ë°€ë¦¬ì´ˆ ë‹¨ìœ„ë¡œ ë°ì´í„°ë¥¼ ê³„ì† refetching í•´ì˜´

## 2ï¸âƒ£ useMutation í›…

API ì—”ë“œí¬ì¸íŠ¸ë‚˜ DBì— ë°ì´í„°ë¥¼ ìƒˆë¡œ ìƒì„±, ìˆ˜ì •, ì‚­ì œ

### ì‚¬ìš©ë²•

```jsx
const mutation = useMutation({ mutationFn: mutationFunction });
```

`mutationFn` í•„ìˆ˜ ì˜µì…˜.

- ì‹¤í–‰í•˜ê³ ì í•˜ëŠ” í•¨ìˆ˜ë¥¼ **ë°˜í™˜**í•˜ëŠ” í•¨ìˆ˜
- ì˜ˆì‹œ
  ```jsx
  const AddUser = useMutation({
      mutationFn: ( user ) => {

        return fetch('https://jsonplaceholder.typicode.com/users',
        {
          method:'post',
          headers: {
             "Content-Type": "application/json",
        },
        body:JSON.stringify( user )
      }).then( res =>  res.json() )
    })
  ```

`ë°˜í™˜ê°’` ë®¤í…Œì´ì…˜ ì‹¤í–‰ ê²°ê³¼ì™€ ê´€ë ¨ëœ ì •ë³´ë¥¼ ë‹´ì€ **ê°ì²´**

ëŒ€í‘œì ì¸ **í”„ë¡œí¼í‹°**

- `isLoading` ë®¤í…Œì´ì…˜ì´ í˜„ì¬ ë¡œë”© ì¤‘ì¸ì§€ ì—¬ë¶€ (boolean)
- `isSuccess` ë®¤í…Œì´ì…˜ ê²°ê³¼ê°€ ì„±ê³µì¸ì§€ ì—¬ë¶€ (boolean)
- `isError` ë®¤í…Œì´ì…˜ ê²°ê³¼ê°€ ì˜¤ë¥˜ì¸ì§€ ì—¬ë¶€ (boolean)
- `data` ë®¤í…Œì´ì…˜ ì‹¤í–‰ í›„ ë°˜í™˜ëœ ë°ì´í„° (ìˆì„ ë•Œë§Œ)
- `mutate` í•´ë‹¹ ë®¤í…Œì´ì…˜ ì‹¤í–‰ì„ ìœ„í•´ í˜¸ì¶œí•  **ë©”ì†Œë“œ**. (ì¸ìì— ë‹´ì„ ë³€ìˆ˜ë¥¼ ê°ì²´ë¡œ ì „ë‹¬)
- `reset` ë®¤í…Œì´ì…˜ ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹í•˜ëŠ” **ë©”ì†Œë“œ**
- `onSuccess` ë®¤í…Œì´ì…˜ ì„±ê³µì‹œ í˜¸ì¶œí•  ì½œë°±í•¨ìˆ˜
- `onError` ë®¤í…Œì´ì…˜ ì‹¤íŒ¨ì‹œ í˜¸ì¶œí•  ì½œë°±í•¨ìˆ˜

## 3ï¸âƒ£ Query Caching

ì›ê²© ì„œë²„ì™€ í†µì‹ í•˜ëŠ”ë°ì— ê±¸ë¦¬ëŠ” ì‹œê°„ì„ ë‹¨ì¶•í•˜ê³ ì,

ì—¬ëŸ¬ë²ˆ ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ëŠ” ìºì‹œì— ì €ì¥í•˜ì—¬ ë°˜ë³µí•´ì„œ í•„ìš”ë¡œ í•  ê²½ìš° ì›ê²© ì„œë²„ê°€ ì•„ë‹Œ ìºì‹œì—ì„œ ë¹ ë¥´ê²Œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ë°©ì‹

useQuery í›… ì‚¬ìš© ì‹œ, ì§€ì •í–ˆë˜ **`ê³ ìœ  í‚¤`** ë°‘ì— **ë°˜í™˜ëœ ë°ì´í„°ê°€ ìºì‹±**ëœë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œëŠ” ìºì‹œ ë°ì´í„°ëŠ” **ì˜¤ë˜ëœ(stale) ìƒíƒœ**ë¡œ ê¸°ë¡ëœë‹¤.

**[ Query Cachingê³¼ ê´€ë ¨ëœ useQuery ì˜µì…˜ ]**

```jsx
const query = useQuery({
    queryKey: [â€˜usersâ€™],
    queryFn: getUsers,
    staleTime: 5000,
    cacheTime: 60000
  })
```

`staleTime` xxë°€ë¦¬ì´ˆ í›„ì— ë°ì´í„°ëŠ” **stale ìƒíƒœ**ë¡œ ì²˜ë¦¬ëœë‹¤.

`cacheTime` xxë°€ë¦¬ì´ˆ í›„ì— ìºì‹œ ë°ì´í„°ëŠ” **ê°€ë¹„ì§€ ì»¬ë ‰ì…˜**ìœ¼ë¡œ ê°„ë‹¤. (ë²„ë ¤ì§)

## 4ï¸âƒ£ Query Invalidation

ì§€ì •í•´ì¤€ `staleTime` ê³¼ ë¬´ê´€í•˜ê²Œ ì¦‰ì‹œ ë°ì´í„°ë¥¼ stale ìƒíƒœë¡œ ì²˜ë¦¬í•´ì•¼í•˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, APIì— POST ìš”ì²­ì„ ë³´ë‚´ ë°ì´í„° ê°’ì„ ì—…ë°ì´íŠ¸í•  ë•Œì—”, API ì—”ë“œí¬ì¸íŠ¸ì— ìˆëŠ” ë°ì´í„°ì˜ ê°’ì´ ìºì‹œì— ì €ì¥ë˜ì–´ìˆëŠ” ê°’ë³´ë‹¤ ë” ìµœì‹  ìƒíƒœê°€ ë˜ê³ , ìºì‹œì— ì €ì¥ë˜ì–´ìˆëŠ” ë°ì´í„°ëŠ” ê³§ë°”ë¡œ outdatedí•œ ê°’ì´ ë˜ì–´ë²„ë¦°ë‹¤. ì´ëŸ´ ë•Œì—” ì¦‰ì‹œ ìºì‹œ ë°ì´í„°ë¥¼ stale ìƒíƒœë¡œ ì²˜ë¦¬í•´ì¤˜ì•¼ í•œë‹¤.

> React Queryì˜ `QueryClient` **ê°ì²´**ì˜ `invalidateQueries` **ë©”ì†Œë“œ** í™œìš©

- **ëª¨ë“  ì¿¼ë¦¬**, í˜¹ì€ ê³ ìœ  í‚¤ë¥¼ í†µí•´ **íŠ¹ì • ì¿¼ë¦¬**ë¥¼ stale ìƒíƒœë¡œ ì²˜ë¦¬í•´ì£¼ëŠ” ì—­í• 

### ì‚¬ìš©ë²•

- `useQueryClient` í›…ì„ í†µí•´ **queryClient ê°ì²´** ìƒì„±
- ê°ì²´ ë‚´ì¥ **ë©”ì†Œë“œ** `invalidateQueries` í™œìš©í•˜ê¸°

```jsx
import { useQueryClient } from "@tanstack/react-query";

// useQueryClient í›…ì„ ì‚¬ìš©í•˜ì—¬ queryClient ê°ì²´ ìƒì„±
const queryClient = useQueryClient();

// ìºì‹œì˜ ëª¨ë“  ì¿¼ë¦¬ ë¬´íš¨í™”
queryClient.invalidateQueries();

// 'users'ë¡œ ì‹œì‘í•˜ëŠ” í‚¤ê°€ ìˆëŠ” ëª¨ë“  ì¿¼ë¦¬ ë¬´íš¨í™”
queryClient.invalidateQueries({ queryKey: ["users"] });
```

## ğŸ“Œ ìš”ì•½

- React í›…ì„ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë¥¼ ê°„í¸í•˜ê²Œ Fetch/Update
- ìŠ¤ë§ˆíŠ¸ ìºì‹± ë©”ì»¤ë‹ˆì¦˜

â†’ ì½”ë“œ ê°„ì†Œí™” & ì„±ëŠ¥ ìµœì í™”

> React QueryëŠ” ê°•ë ¥í•œ **Server State ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬**ì´ë‹¤!
